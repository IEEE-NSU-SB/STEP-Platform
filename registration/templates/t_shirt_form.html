{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T-Shirt Registration Form</title>
  <link rel="icon" href="{% static '/img/logo.gif' %}" />
  <!--daisy ui-->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <!--tailwind-->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- sweet alert  -->
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!--particles.js-->
  <script src="{% static 'js/particles.min.js' %}"></script>
  <!-- stats.js lib --> 
  <script src="http://threejs.org/examples/js/libs/stats.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#055f8b",
            secondary: "#f17727",
          },
        },
      },
    };
  </script>
  <style>
     body {
      /* background-image: url("{% static '/img/StepBG.png' %}"); */
      background: transparent;
      background-repeat: no-repeat;
      background-size: cover;
      position: relative;
      z-index: 0;
      font-family: "Inter", sans-serif;
    }
    .response_count{
      /* font-weight: bold; */
      font-size: larger;
      border-bottom: 2px solid #00629b;
      border-right: 2px solid #00629b;
      padding: 4px 8px;
      border-radius: 8px;
      background: #dceffa;
      color: #00629b;
      /* font-style: italic; */
    }
    @media screen and (max-width:500px){
      .response_count{
        margin: 0 auto;
      }
    }
    /* particles container */
    canvas{ display: block; vertical-align: bottom; } /* ---- particles.js container ---- */ #particles-js{ position:absolute; width: 100%; height: 100%; background-color: #00629b; background-image: url(""); background-repeat: no-repeat; background-size: 20%; background-position: 50% 50%; } /* ---- stats.js ---- */ .count-particles{ background: #000022; position: absolute; top: 48px; left: 0; width: 80px; color: #13E8E9; font-size: .8em; text-align: left; text-indent: 4px; line-height: 14px; padding-bottom: 2px; font-family: Helvetica, Arial, sans-serif; font-weight: bold; } .js-count-particles{ font-size: 1.1em; } #stats, .count-particles{ -webkit-user-select: none; margin-top: 5px; margin-left: 5px; } #stats{ border-radius: 3px 3px 0 0; overflow: hidden; } .count-particles{ border-radius: 0 0 3px 3px; }
  </style>
</head>

<body class="min-h-screen py-8">

<div id="particles-js" class="fixed inset-0 -z-10"></div>

   <nav class="w-11/12 md:w-3/5 mx-auto my-4">
    <div class="rounded overflow-hidden shadow-lg flex justify-center">
        {% if not is_staff_view and not is_published and not registration_closed %}
        <img style="height: 70vh;" src="{% static '/img/Stepclosed.png' %}" alt="" class="object-cover h-auto max-h-screen">
        {% else %}
        <img src="{% static '/img/StepBanner.png' %}" alt="" class="object-cover h-auto">
        {% endif %}
    </div>
  </nav>
  {% if has_perm.reg_form_control %}
  <!-- admin feature part  -->
  <!-- Button Header -->
  <div class="rounded">
    
    <div class="bg-white w-11/12 md:w-3/5 mx-auto px-6 py-5" style="backdrop-filter:blur(7px); border-radius: 4px 4px; box-shadow: 0 2px 6px 0px #00000078; position: relative; top: 14px;">
      <!-- <div class="flex flex-wrap gap-3 items-center justify-between"> -->
        <div class="flex flex-col sm:flex-row sm:flex-wrap items-center justify-between">
          <div>
            <!-- Publish Form Toggle Button (staff only) -->
            <button id="publishToggle" type="button" class="inline-flex items-center gap-2 px-0 py-2.5 rounded-md font-medium text-lg">
              <input id="publishCheckbox" type="checkbox" {% if is_published %}checked="checked"{% endif %}
              class="toggle border-gray-300 bg-gray-400 checked:border-blue-500 checked:bg-blue-400 checked:text-blue-800" />
              {% if is_published %}
              <span class="text-xl" style="color: rgb(0, 155, 31);" id="publishText">Form published!</span>
              {% else %}
              <span class="text-xl" style="color: rgb(207, 25, 18);" id="publishText">Publish Form?</span>
              {% endif %}
            </button>
          </div>
          <p class="response_count">Response Count: <span style="font-weight: bold;">{{registration_count}}</span></p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 items-center justify-center sm:justify-center w-full sm:w-auto my-3"> 
      
      {% if has_perm.view_reg_responses_list %}
      <!-- See Responses Button (staff only) -->
      <a href="{% url 'registration:t_shirt_responses' %}"
      class="inline-flex items-center gap-2 px-5 py-2.5 w-64 sm:w-auto max-sm:my-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-md font-medium text-lg transition-all duration-200 transform hover:scale-105 hover:from-blue-600 hover:to-blue-700 hover:shadow-lg focus:outline-none  focus:ring-blue-500 focus:ring-offset-2">
      <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
        <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M17,17H7V15H17V17M17,13H7V11H17V13M17,9H7V7H17V9Z" />
      </svg>
      <span>See Responses</span>
    </a>
    {% endif %}
  </div>
  {% endif %}
  
</div>

<div class="bg-white w-11/12 md:w-3/5 mx-auto" style="backdrop-filter:blur(7px);border-radius:4px 4px; box-shadow: 0 2px 6px 0px #00000078;">
    {% if not is_staff_view and not is_published and not registration_closed%}
    <div class="p-6 bg-yellow-50 border border-yellow-300 rounded text-yellow-900 text-center">
      {% comment %} Registration is not open yet. Please check back later. {% endcomment %}
      <p>Registration is closed as we have reached the maximum number of participants.</p>
      <p>If you have any other queries, please contact: 01309570567</p>
      </div>
    {% elif not is_staff_view and registration_closed %}
      <div class="p-6 bg-red-50 border border-red-300 rounded text-red-900 text-center">
        Registration is closed as we have reached the maximum number of participants.  
      </div>
    {% else %}
    <!-- Step indicator
    <div class="flex justify-between mb-8">
      <div id="step1Indicator" class="w-1/3 text-center font-bold text-primary">1. Basic Info</div>
      <div id="step2Indicator" class="w-1/3 text-center text-gray-500">2. Questionnaire</div>
      <div id="step3Indicator" class="w-1/3 text-center text-gray-500">3. Payment</div>
    </div> -->

    <!-- Form wrapper -->
    <form id="registrationForm" method="post" action="/submit_t_shirt_form/">
      {% csrf_token %}
      
      <!-- Step 1: Basic Info -->
      <section id="step1" class="shadow-md p-5 font-medium rounded-md">
        <h2 class="text-xl text-center mb-5">IEEE Student Transition and Elevation Partnership 2025 - <br> Igniting Future Innovators</h2>
        <h2 class=" text-center text-3xl mb-6">T-Shirt Registration</h2>
        <p>Apply here to get your official STEP-25 T-Shirt!</p>
        <br>
        <span style="font-weight: bold;">Registration Deadline: September 24, 2025 @ 11:59 PM</span>
        <br>
        If you face any difficulty, please contact 01309570567
        <br>
        <br>
        </p>

        <div class="mb-5">
      <label for="name" class="block uppercase text-lg  mb-1">
        Full Name<span class="text-red-500">*</span>
      </label>
      <input type="text" name="name" id="name" placeholder="Enter your Name"
        class="w-full px-3 py-2 border border-gray-500 rounded-md focus:outline-none  " required />

    </div>
    <div class="mb-5">
      <label for="email" class="block uppercase text-lg  mb-1">
        Email Address<span class="text-red-500">*</span>
      </label>
      <input type="email" name="email" id="email" placeholder="Enter your Email"
        class="w-full px-3 py-2 border border-gray-500 rounded-md focus:outline-none  " required />
    </div>
    <div class="mb-5">
      <label for="contact_number" class="block uppercase text-lg  mb-1">
        Contact Number<span class="text-red-500">*</span>
      </label>
      <input type="number" name="contact_number" id="contact_number" placeholder="Enter your Contact Number"
        class="w-full px-3 py-2 border border-gray-500 rounded-md focus:outline-none " required />
    </div>
    <div class="mb-5">
      <label for="ieee_id" class="block uppercase text-lg  mb-1">
        IEEE Membership ID (Write N/A if you're Non-IEEE Member)<span class="text-red-500">*</span>
      </label>
      <input  type="text" name="ieee_id" id="ieee_id" placeholder="Enter your Membership ID"
        class="w-full px-3 py-2 border border-gray-500 rounded-md focus:outline-none " required />
    </div>


    <!-- shirt table  -->
    <h2 class="mb-1">Size Chart</h2>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse text-xs sm:text-lg min-w-full bg-gray-50">
        <thead>
          <tr>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-left font-semibold text-gray-700">
              Sizes</th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">S
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">M
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">L
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">XL
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">2XL
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">3XL
            </th>
            <th class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 text-center font-semibold text-gray-700">4XL
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 font-semibold text-gray-700">Chest</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">36"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">38"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">40"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">42"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">44"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">46"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">48"</td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-300 bg-gray-50 px-2 py-2 sm:px-3 font-semibold text-gray-700">Body
            </td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">26"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">27"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">28"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">29"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">30"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">31"</td>
            <td class="border border-gray-300 px-2 py-2 sm:px-3 text-center">31"</td>
          </tr>
        </tbody>
      </table>
    </div> 

    <div class="mb-4 mt-3">
      <label class="block uppercase   mb-1 ">
        Select T-Shirt size<span class="text-red-500">*</span>
      </label>
      <div class="flex flex-col gap-2 ml-6">
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="S" class="form-radio text-blue-500" required>
          S
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="M" class="form-radio text-blue-500" required>
          M
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="L" class="form-radio text-blue-500" required>
          L
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="XL" class="form-radio text-blue-500" required>
          XL
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="2XL" class="form-radio text-blue-500" required>
          2XL
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="3XL" class="form-radio text-blue-500" required>
          3XL
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="tshirt_size" value="3XL" class="form-radio text-blue-500" required>
          4XL
        </label>
      </div>
    </div>

      <div class="flex justify-center">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
      </div>
    </section>
    </form>
    {% endif %}
  </div>
</div>

{% if is_staff_view %}
<div id="publishModal" class="fixed inset-0 hidden bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
    <h2 class="text-xl font-semibold mb-4">Confirm Publish</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to publish this form? Once published, it will be available for users to fill.</p>
    <div class="flex justify-center gap-4">
      <button id="cancelPublish" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="confirmPublish" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Yes, Publish</button>
    </div>
  </div>
</div>

<!-- Unpublish Confirmation Modal -->
<div id="unpublishModal" class="fixed inset-0 hidden bg-black/20 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
    <h2 class="text-xl font-semibold mb-4">Confirm Unpublish</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to unpublish this form? Users will no longer be able to fill it.</p>
    <div class="flex justify-center gap-4">
      <button id="cancelUnpublish" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
      <button id="confirmUnpublish" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Yes, Unpublish</button>
    </div>
  </div>
</div>
{% endif %}

<div class="flex justify-center items-center mt-3">
  <p class="text-white"><small>2025 Â© All rights reserved by IEEE NSU Student Branch</small></p>
</div>
  <script>
        
function validateStep(stepNumber) {
  const currentStep = document.getElementById(`step${stepNumber}`);
  const requiredFields = currentStep.querySelectorAll('[required]');
  let isValid = true;

  requiredFields.forEach(field => {
    let fieldWrapper = field.closest("div"); // optional: highlight wrapper instead of only input

    if (field.type === 'radio') {
      const radioGroup = currentStep.querySelectorAll(`[name="${field.name}"]`);
      const isChecked = Array.from(radioGroup).some(radio => radio.checked);

      if (!isChecked) {
        isValid = false;
        radioGroup.forEach(radio => radio.classList.add("border-red-500"));
      } else {
        radioGroup.forEach(radio => radio.classList.remove("border-red-500"));
      }

    } else if (!field.value.trim()) {
      isValid = false;
      field.classList.add("border-red-500");
    } else {
      field.classList.remove("border-red-500");
    }
  });

  return isValid;
}

function nextStep(current) {
  if (!validateStep(current)) {
    Swal.fire("Please fill in all the required fields!");
    return; // stop here if invalid
  }

  document.getElementById(`step${current}`).classList.add("hidden");
  document.getElementById(`step${current + 1}`).classList.remove("hidden");
}

function prevStep(current) {
  document.getElementById(`step${current}`).classList.add("hidden");
  document.getElementById(`step${current - 1}`).classList.remove("hidden");
}

    function prevStep(current) {
      document.getElementById(`step${current}`).classList.add("hidden");
      document.getElementById(`step${current - 1}`).classList.remove("hidden");
      updateIndicators(current - 1);
    }

   function updateIndicators(step) {
  // Check if indicators exist
  if (!document.getElementById('step1Indicator')) {
    return;
  }
  
  [1, 2, 3].forEach(num => {
    const indicator = document.getElementById(`step${num}Indicator`);
    if (indicator) {
      indicator.classList.remove("text-primary", "font-bold");
      indicator.classList.add("text-gray-500");
    }
  });
  
  const activeIndicator = document.getElementById(`step${step}Indicator`);
  if (activeIndicator) {
    activeIndicator.classList.remove("text-gray-500");
    activeIndicator.classList.add("text-primary", "font-bold");
  }
}

    // Handle form submission
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Show loading state
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;
      
      
      // using formdata to handle file uploads
      const formData = new FormData(this);
      
      // fetch API to submit form data
      fetch(this.action, {
        method: 'POST',
        body: formData, 
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || ''
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
        //  alert('Registration successful! Your participant ID is: ' + data.participant_id);
        Swal.fire({
          title: "Registration Complete ðŸŽŠ",
          text: "Thanks for signing up! Get ready for an amazing experience. Please check your confirmation mail in your inbox/spam",
          icon: "success",
          draggable: true
        });
          // Reset form
          this.reset();
        // Go back to step 1
const step3 = document.getElementById('step3');
const step1 = document.getElementById('step1');
if (step3) step3.classList.add('hidden');
if (step1) step1.classList.remove('hidden');
updateIndicators(1);
        } else {
          alert('Registration failed: ' + data.message);
        }
      })
      .catch(error => {
        alert('Registration failed: ' + error.message);
      })
      .finally(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    });


{% if is_staff_view %}
// Get elements
const publishToggle = document.getElementById('publishCheckbox');
const publishText = document.getElementById('publishText');
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

if (publishToggle) {
  publishToggle.addEventListener('change', () => {
    if (publishToggle.checked) {
      // Show Publish Modal
      document.getElementById('publishModal').classList.remove('hidden');
    } else {
      // Show Unpublish Modal
      document.getElementById('unpublishModal').classList.remove('hidden');
    }
  });

  // --- Publish Modal ---
  document.getElementById('cancelPublish').addEventListener('click', () => {
    document.getElementById('publishModal').classList.add('hidden');
    publishToggle.checked = false; // revert toggle
  });

  document.getElementById('confirmPublish').addEventListener('click', () => {
    document.getElementById('publishModal').classList.add('hidden');
    // Send AJAX request to publish
    fetch('{% url "registration:toggle_publish" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    })
    .then(r => r.json())
    .then(data => {
      publishText.textContent = data.is_published ? 'Form published!' : 'Publish Form?';
      publishText.style.color = data.is_published ? '#009b1f' : '#cf1912';
      // alert('Publish status: ' + (data.is_published ? 'Published' : 'Unpublished'));
    })
    .catch(err => alert('Failed to toggle publish: ' + err.message));
  });

  // --- Unpublish Modal ---
  document.getElementById('cancelUnpublish').addEventListener('click', () => {
    document.getElementById('unpublishModal').classList.add('hidden');
    publishToggle.checked = true; // revert toggle
  });

  document.getElementById('confirmUnpublish').addEventListener('click', () => {
    document.getElementById('unpublishModal').classList.add('hidden');
    // Send AJAX request to unpublish
    fetch('{% url "registration:toggle_publish" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    })
    .then(r => r.json())
    .then(data => {
      publishText.textContent = data.is_published ? 'Form published!' : 'Publish Form?';
      publishText.style.color = data.is_published ? '#009b1f' : '#cf1912';
      // alert('Publish status: ' + (data.is_published ? 'Published' : 'Unpublished'));
    })
    .catch(err => alert('Failed to toggle publish: ' + err.message));
  });
}
{% endif %}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
  particlesJS("particles-js", {"particles":{"number":{"value":160,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle","stroke":{"width":0,"color":"#000000"},"polygon":{"nb_sides":5},"image":{"src":"img/github.svg","width":100,"height":100}},"opacity":{"value":1,"random":true,"anim":{"enable":true,"speed":1,"opacity_min":0,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":false,"speed":4,"size_min":0.3,"sync":false}},"line_linked":{"enable":false,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false,"attract":{"enable":false,"rotateX":600,"rotateY":600}}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":false,"mode":"bubble"},"onclick":{"enable":false,"mode":"repulse"},"resize":true},"modes":{"grab":{"distance":400,"line_linked":{"opacity":1}},"bubble":{"distance":250,"size":0,"duration":2,"opacity":0,"speed":3},"repulse":{"distance":400,"duration":0.4},"push":{"particles_nb":4},"remove":{"particles_nb":2}}},"retina_detect":true});var count_particles, stats, update; stats = new Stats; stats.setMode(0); stats.domElement.style.position = 'absolute'; stats.domElement.style.left = '0px'; stats.domElement.style.top = '0px'; document.body.appendChild(stats.domElement); count_particles = document.querySelector('.js-count-particles'); update = function() { stats.begin(); stats.end(); if (window.pJSDom[0].pJS.particles && window.pJSDom[0].pJS.particles.array) { count_particles.innerText = window.pJSDom[0].pJS.particles.array.length; } requestAnimationFrame(update); }; requestAnimationFrame(update);;
  });
</script>
<script>
  document.querySelectorAll('input[name="is_student"]').forEach((radio) => {
  radio.addEventListener('change', function () {
    document.getElementById("is_student_bool").value =
      this.value === "student" ? "True" : "False";
  });
});
</script>
<script>
  const radios = document.querySelectorAll('input[name="membership_type"]');
  const q3 = document.getElementById('q3');
  const q4 = document.getElementById('q4');

  radios.forEach(radio => {
    radio.addEventListener('change', function () {
      if (this.value === 'non_ieee') {
        // hide q3 and q4
        q3.style.display = 'none';
        q4.style.display = 'none';

        // remove "required" so form can submit
        q3.querySelector('textarea').required = false;
        q4.querySelector('textarea').required = false;

      } else {
        // show all
        q3.style.display = 'block';
        q4.style.display = 'block';

        // restore required
        q3.querySelector('textarea').required = true;
        q4.querySelector('textarea').required = true;
      }
    });
  });
</script>
</body>

</html>
